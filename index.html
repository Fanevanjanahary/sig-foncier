<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Futurmap - Foncier</title>
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="css/font-awesome.min.css" rel="stylesheet">
	<link href="css/datepicker3.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    
    <!--mapbox-->
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.51.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.51.0/mapbox-gl.css' rel='stylesheet' />
	
    <script language="JavaScript"  src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-1.11.1.js"></script>
	
	<!--Custom Font-->
	<link href="https://fonts.googleapis.com/css?family=Montserrat:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">
	<!--[if lt IE 9]>
	<script src="js/html5shiv.js"></script>
	<script src="js/respond.min.js"></script>
    <![endif]-->
    <style>
        #map { position:absolute; top:0; bottom:0; width: 100%}
        #map-container {margin: 0; padding: 0; height: 670px;}
    </style>
</head>
<body>
	<nav class="navbar navbar-custom navbar-fixed-top" role="navigation">
		<div class="container-fluid">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#sidebar-collapse"><span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span></button>
				<a class="navbar-brand" href="#"><span>Futurmap</span>Foncier</a>
			</div>
		</div><!-- /.container-fluid -->
	</nav>
	<div id="sidebar-collapse" class="col-sm-3 col-lg-2 sidebar">

		<ul class="nav menu">
			
			<li class="parent "><a data-toggle="collapse" href="#sub-item-1">
				Parcelles <span data-toggle="collapse" href="#sub-item-1" class="icon pull-right"><em class="fa fa-plus"></em></span>
				</a>
				<ul class="children collapse" id="sub-item-1">
				</ul>
			</li>

			<li class="parent "><a data-toggle="collapse" href="#sub-item-2">
				Parcelles <span data-toggle="collapse" href="#sub-item-2" class="icon pull-right"><em class="fa fa-plus"></em></span>
				</a>
				<ul class="children collapse" id="sub-item-2">
				</ul>
			</li>
			
		</ul>
	</div><!--/.sidebar-->
		
	<div class="col-sm-9 col-sm-offset-3 col-lg-10 col-lg-offset-2 main width='100%'">
		<div class="row">
			<ol class="breadcrumb">
				<li><a href="#">
					<em class="fa fa-map"></em>
				</a></li>
				<li class="active">Parcelles</li>
			</ol>
		</div><!--/.row-->
		
		
		<div class="row">
            <div id='map-container'>
                <div id='map' class='map'></div>
            </div>		
		</div><!--/.row-->
		
		
	<!--
	<script src="js/jquery-1.11.1.min.js"></script>
	-->	
	<script src="js/bootstrap.min.js"></script>
	<script src="js/bootstrap-datepicker.js"></script>
    <script src="js/custom.js"></script>
    
	<script>
	
        if (!('remove' in Element.prototype)) {
             Element.prototype.remove = function() {
            if (this.parentNode) {
                this.parentNode.removeChild(this);
            }
            };
		 }
		 
		var region
		var site
		var parcelle
		var borne

		$.getJSON("data/site.geojson", function(json){
    		site = json;
		});

		$.getJSON("data/region.geojson", function(json){
    		region = json;
		});

		$.getJSON("data/parcelle.geojson", function(json){
    		parcelle = json;
		});

		$.getJSON("data/borne.geojson", function(json){
    		borne = json;
		});

		
        mapboxgl.accessToken = 'pk.eyJ1IjoiZmFuZXZhIiwiYSI6ImNqZGxhOW5rMDA0bnkzM3A4MmJldm8ydmQifQ.EKyPWlXVcZ6ZcP_5ve6GOQ';

      
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/outdoors-v10',
            center: [47.527, -18.989],
            zoom: 5
        });
		

		map.on("load", function(e) {

			// add sources
			map.addSource("parcelle", {
				"type": "geojson",
				"data": parcelle
			});

			map.addSource("borne", {
				"type": "geojson",
				"data": borne
			});

			map.addSource("region", {
				"type": "geojson",
				"data": region
			});
			
			map.addSource("site", {
					"type": "geojson",
					"data": site
				});

			map.addSource("region_existed", {
				"type": "geojson",
				"data": getRegion()
			});

			// add layers

			map.addLayer({
				"id": "Borne",
				"type": "symbol",
				"source": "borne",
				"interactive": true,
				"layout": {
					"text-field": "IF",
					"icon-image": "marker-16",
				},
				"paint": {
					"text-color": {
						property: 'EXISTANTE',
                           type:  'categorical',
                           stops: [
                            ['OUI', '#b35a2a'],
                            ['NON', '#377eb8'],
                            
                          ]
						},
					"text-halo-width": 2,
					
					
				}
			
			});

			map.addLayer({
				"id": "Site",
				"type": "line",
				"source": "site",
				"layout": {},
				"paint": {
					"line-color": "red",
					"line-opacity": .8
				},
			});

			map.addLayer({
				"id": "Parcelle",
				"type": "fill",
				"source": "parcelle",
				"layout": {},
				"paint": {
					"fill-color": "green",
					"fill-opacity": 0.8
				},
			});

			map.addLayer({
				"id": "Region",
				"type": "line",
				"source": "region",
				"layout": {},
				"paint": {
					"line-color": "#6d96cc",
					"line-width": 2,
					"line-opacity": .8
				},
			});

			map.addLayer({
				"id": "Region existed",
				"type": "fill",
				"source": "region_existed",
				"layout": {},
				"paint": {
					"fill-color": "#6d96cc",
					"fill-opacity": 0.8
				},
			});
		
			parecelleList(site, map)
			map.on("click", "Borne", function (e) {
				new mapboxgl.Popup()
					.setLngLat(e.lngLat)
					.setHTML('<h1 classe="item">Borne IF</h1>'+
						'<p><span>Existant:	</span>' 
						+e.features[0].properties.EXISTANTE+
						'</p>'+
						'<p><span>Parcelle:	</span>' 
						+e.features[0].properties.PARCELLE+
						'</p>'+
						'<p><span>Numero:	</span>' 
						+e.features[0].properties.NUMERO+
						'</p>'
					)
					.addTo(map);
			});

			map.on('zoomend', function() {
				if (map.getZoom() >12){
						map.removeLayer('Region existed');
				}
				
			});

			map.on("mouseenter", "Borne", function () {
				map.getCanvas().style.cursor = "pointer";
			});

			map.on("mouseleave", "Borne", function () {
				map.getCanvas().style.cursor = "";
			});
		//end 
		});

		function getUniqueValueSite(entity)
		{
			var uniqueRegion = [];
			for(k = 0; k< site.features.length; k++){    
				if(uniqueRegion.indexOf(site.features[k].properties[entity]) === -1){
					uniqueRegion.push(site.features[k].properties[entity]);        
				}       
			};
			return uniqueRegion;
		}
		
		function getRegion()
		{
			region_existed_json = {
				"type": "FeatureCollection",
				"name": "region",
				"crs": { "type": "name", "properties": { "name": "urn:ogc:def:crs:OGC:1.3:CRS84" } },
				"features": []
			}
			region_existed = []
			uniqueRegion = getUniqueValueSite("REGION")
			for(iregion=0; iregion<region.features.length; iregion++)
			{
				for(isite=0; isite<uniqueRegion.length; isite++)
				{
					if(region.features[iregion].properties["Nom_region"] == uniqueRegion[isite])
					{
						region_existed.push(region.features[iregion])
					}
				}
			}
			region_existed_json["features"] = region_existed
			return region_existed_json
				
		}
		
		function parecelleList(data, map){
			site_nom = getUniqueValueSite("NOM")
			var listings = document.getElementById('sub-item-2')
			for (inom =0; inom < site_nom.length; inom++){
				
				var listing = listings.appendChild(document.createElement('li'))
				var link = listing.appendChild(document.createElement('a'))
				link.href = '#';
				link.className = 'title';
				link.dataPosition = inom;
				var span = link.appendChild(document.createElement('span'))
				span.className = 'fa fa-map-marker'
				span.innerHTML = '&nbsp;'+ site_nom[inom]
				
				link.addEventListener('click', function(e) {
					// Update the currentFeature to the store associated with the clicked link
					var clickedListing = data.features[this.dataPosition];
					// 1. Fly to the point associated with the clicked link
					flyToSite(clickedListing);
					// 2. Close all other popups and display popup for clicked store
					createPopUp(clickedListing);
					// 3. Highlight listing in sidebar (and remove highlight for all other listings)
					
					
				})
			}
		};
			function flyToSite(currentFeature) {
				map.flyTo({
					center: currentFeature.geometry.coordinates[0][0][0],
					zoom: 17
				});
			}

			function createPopUp(currentFeature) {
				var popUps = document.getElementsByClassName('mapboxgl-popup');
				// Check if there is already a popup on the map and if so, remove it
				if (popUps[0]) popUps[0].remove();

				var popup = new mapboxgl.Popup({ closeOnClick: true })
					.setLngLat(currentFeature.geometry.coordinates[0][0][0])
					.setHTML('<div>'+
					'<h5>'+ currentFeature.properties.NOM + '</h5>' +
					'</div>'
					)
					.addTo(map);

			}
		
	</script>

<style>
	.mapboxgl-popup-content h1 {
		background: #fff;
		color: rgb(48, 165, 255);
		border-bottom: 1px solid rgb(48, 165, 255);;
		margin: 0;
		display: block;
		padding: 8px;
		border-radius: 3px 3px 0 0;
		font-weight: 600;
		margin-top: -10px;
		font-size: 15px;
		width: 150px; 
		text-align: center
	}

	.mapboxgl-popup-content p {
		margin: 0;
		background: #fff;
		color: #4a4d4b;
		border-radius: 3px 3px 0 0;
		font-weight: 600;
		margin-top: 10px;
		font-size: 13px;
		width: 150px; 
		padding-left: 10px
		
	}

</style>
</body>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</html>